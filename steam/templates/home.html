{% extends "base.html" %}
{% block content %}
	<!-- only when user is admin below code inside if else will run-->
	{% if 'admin' in session %}
		<style type="text/css">
			/* Popup box BEGIN */
			.addGamePopup{
			    background:rgba(0,0,0,.4);
			    cursor:pointer;
			    display:none;
			    height:100%;
			    position:fixed;
			    text-align:center;
			    top:0;
			    width:100%;
			    z-index:10000;
			}
			.addGamePopup .helper{
			    display:inline-block;
			    height:100%;
			    vertical-align:middle;
			}
			.addGamePopup > div {
			    background-color: #fff;
			    box-shadow: 10px 10px 60px #555;
			    display: inline-block;
			    height: auto;
			    max-width: 551px;
			    min-height: 100px;
			    vertical-align: middle;
			    width: 60%;
			    position: relative;
			    border-radius: 8px;
			    padding: 15px 5%;
			}
			.popupCloseButton {
			    background-color: #fff;
			    border: 3px solid #999;
			    border-radius: 50px;
			    cursor: pointer;
			    display: inline-block;
			    font-family: arial;
			    font-weight: bold;
			    position: absolute;
			    top: -20px;
			    right: -20px;
			    font-size: 25px;
			    line-height: 30px;
			    width: 30px;
			    height: 30px;
			    text-align: center;
			}
			.popupCloseButton:hover {
			    background-color: #ccc;
			}
			.trigger_popup_fricc {
			    cursor: pointer;
			    font-size: 20px;
			    margin: 20px;
			    display: inline-block;
			    font-weight: bold;
			}
			/* Popup box BEGIN */
		</style>
		&nbsp <button type="button" class="btn btn-primary" onclick="open_addGamePopup()">Add game</button>
		<button type="button" class="btn btn-primary" onclick="window.open('/manageUser')">Manage Users</button>


		<div class="addGamePopup">
		    <span class="helper"></span>
		    <div>
		        <div class="popupCloseButton" onclick="close_popup()">&times;</div>
		        <div id="popupContent">
		        	Game name: <input type="text" id="name" name="name"><br>
		        	Description: <textarea id="description" rows="4" cols="20">  </textarea><br>
	 				Release date: <input type="date" id="release_date" name="release_date"> <br>
		        	Developers: <input type="text" id="developers" name="developers" placeholder=" ; seperated"><br>
		        	Publishers: <input type="text" id="publishers" name="publishers" placeholder=" ; seperated"><br>
		        	Platforms: <input type="text" id="platforms" name="platforms" placeholder=" ; seperated"><br>
		        	Required Age: <input type="number" id="required_age" name="required_age" placeholder=" Integer"><br>
		        	Categories:<input type="text" id="categories" name="categories" placeholder=" ; seperated"><br>
		        	Genres: <input type="text" id="genres" name="genres" placeholder=" ; seperated"><br>
		        	Tags: <input type="text" id="tags" name="tags" placeholder=" ; seperated"><br>
		        	Achievements: <input type="text" id="achievements" name="achievements" placeholder=" Integer"><br>
		        	Price: <input type="number" id="price" name="price" placeholder=" in INR"><br>
		        	<button onclick="addGameRequest()"> Add game </button>
		        </div>
		    </div>
		</div>

		<script type="text/javascript">
			function close_popup(){
				$('.addGamePopup').hide();
			}
			function open_addGamePopup(){
				$('.addGamePopup').show();
			}
			
			function addGameRequest(){
				$.post("/addGame",
				 {
				 	name: $("#name").val(),
				 	release_date: $("#release_date").val(),
				 	description: $("#description").val(),
				 	developers: $("#developers").val(),
				 	publishers: $("#publishers").val(),
				 	platforms: $("#platforms").val(),
				 	required_age: $("#required_age").val(),
				 	categories: $("#categories").val(),
				 	genres: $("#genres").val(),
				 	tags: $("#tags").val(),
				 	achievements: $("#achievements").val(),
				 	price: $("#price").val()
				 },
				 function(data, status){
				 	if(status=='success'){
				 		if(confirm(data)){
				 		    window.location.reload();  
				 		}
				 	}
				 });
			}
		</script>
	<br>
	<br>
	{% endif %}
	&nbsp&nbsp<input type="text" id="searchBar" name="fname" placeholder="search games by name">
	<Button id="searchButton" onclick="search()"> Search </Button> <br>
	
	<br>
	{% set rows = (totalRows/10)|round|int %}
	<div id="pageInfo"> Showing page 1 of {{rows}}</div>
	<button onclick="prev()"> previous page </button>
	<button onclick="next()"> next page </button> <br>
	<div id="table">
		<table style="width:100%">
			  <tr>
			    <th>Game name</th>
			    <th>Release date</th>
			    <th>Price</th>
			    {% if 'admin' in session %}
			    <th> Delete game </th>
			    {% endif %}
			  </tr>
			  {% if games %}
			  	{% for gameObj in games %}
			  		<tr>
			  		  <td><a href="/game_details?appid={{gameObj.appid}}">{{gameObj.name}}</a></td>
			  		  <td>{{gameObj.release_date}}</td>
			  		  <td>{{gameObj.price}}</td>
			  		  {% if 'admin' in session %}
			  		  	<td><button class="btn btn-danger" onclick="deleteGame( {{gameObj.appid}} )"> Delete </button></td>
			  		  {% endif %}
			  		</tr>
			  		<!-- <li> <a href="/game_details?appid={{gameObj.appid}}"> {{gameObj.name}}, {{gameObj.release_date}} </a> </li> -->
			  	{% endfor %}
			  {% endif %}
		</table>
	</div>

	<script type="text/javascript">
		var page_num = 1;
		var totalPages = {{rows}};
		var isSearched = false;


		function searchResponseHandler(data, status){
			if(status==='success'){
				isSearched = true;
				var obj = JSON.parse(data);
				{% if 'admin' in session %}
					var newtable = "<table style=\"width:100%\"> <tr> <th>Game name</th> <th>Release date</th> <th>Price</th> <th>Delete game</th> </tr>";
				{% else %}
					var newtable = "<table style=\"width:100%\"> <tr> <th>Game name</th> <th>Release date</th> <th>Price</th> </tr>";
				{% endif %}
				for(let i=0;i<obj.length-1;i++){
					let s = "<tr><td>";
					s += "<a href=\"/game_details?appid="+obj[i]['appid']+"\">"+obj[i]['name']+"</a>"+"</td><td>"
					s += obj[i]['release_date']+"</td> <td>"
					s += obj[i]['price']+"</td>"
					{% if 'admin' in session %}
						s += "<td><button class=\"btn btn-danger\" onclick=\"deleteGame("+obj[i]['appid']+")\"> Delete </button></td>"
					{% endif %}
					s+="</tr>"
					newtable+=s;
				}
				total_rows = obj[obj.length-1]['totalRows']; //last object contains totalrows
				totalPages = parseInt(parseInt(total_rows)/10);
				document.getElementById("table").innerHTML = newtable;
				document.getElementById("pageInfo").innerHTML = "Showing page "+page_num+" of "+ totalPages;
			}
		}

		function getGamesResponseHandler(data,status){
			if(status==='success'){
				var obj = JSON.parse(data);
				{% if 'admin' in session %}
					var newtable = "<table style=\"width:100%\"> <tr> <th>Game name</th> <th>Release date</th> <th>Price</th> <th>Delete game</th> </tr>";
				{% else %}
					var newtable = "<table style=\"width:100%\"> <tr> <th>Game name</th> <th>Release date</th> <th>Price</th> </tr>";
				{% endif %}
				for(let i=0;i<obj.length;i++){
					let s = "<tr>";
					s += "<td> <a href=\"/game_details?appid="+obj[i]['appid']+"\">"+obj[i]['name']+"</a>"+"</td>"
					s += "<td>"+obj[i]['release_date']+"</td>"
					s += "<td>"+obj[i]['price']+"</td>"
					{% if 'admin' in session %}
						s += "<td><button class=\"btn btn-danger\" onclick=\"deleteGame("+obj[i]['appid']+")\"> Delete </button></td>"
					{% endif %}
					s += "</tr>"
					newtable+=s;
				}
				document.getElementById("table").innerHTML = newtable;
				document.getElementById("pageInfo").innerHTML = "Showing page "+page_num+" of "+ totalPages;
			}
		}

		function search(){
			if($("#searchBar").val()==''){
				return;
			}
			page_num = 1; //reset the page number in case of search
			$.post("/searchGames",
			 {
			 	page_num: page_num,
			   	string: $("#searchBar").val()
			 },
			 function(data, status){
			 	searchResponseHandler(data,status);
			 });
		}
		function prev(){
			if(page_num>1){
				page_num--;
				var URL = "/getGames";
				if(isSearched){
					URL = "/searchGames"
				}
				$.post(URL,
				 {
				   page_num: page_num,
				   string: $("#searchBar").val()
				 },
				 function(data, status){
				 	if(isSearched){
				 		searchResponseHandler(data,status);
				 	}
				 	else{
				 		getGamesResponseHandler(data,status);
				 	}
				 });
			}
		}

		function next(){
			if(page_num+1<=totalPages){
				page_num++;
				var URL = "/getGames";
				if(isSearched){
					URL = "/searchGames"
				}
				$.post(URL,
					 {
					   page_num: page_num,
					   string: $("#searchBar").val()
					 },
					 function(data, status){
					 	if(isSearched){
					 		searchResponseHandler(data,status);
					 	}
					 	else{
					 		getGamesResponseHandler(data,status);
					 	}
					 });
			}
		}

		{% if 'admin' in session %}
			function deleteGame(appid){
				console.log("delete",appid);
				var result = confirm("are you sure you want to delete this game?");
				if(result){
					$.post("/deleteGame",
					 {
					 	appid: appid
					 },
					 function(data, status){
					 	if(confirm(data)){
					 	    window.location.reload();  
					 	}
					 });
				}
			}
		{% endif %}

	</script>
{% endblock %}